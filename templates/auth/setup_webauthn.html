{% extends "base.html" %}
{% block title %}Register Passkey{% endblock %}
{% block body_class %}auth-page{% endblock %}

{% block body %}
<h1 style="color:red;">TESTING PAGE RENDER</h1>
<div class="auth-container">
  <h2>üîê Set Up Biometric Login</h2>
  <p>Register a passkey or fingerprint to enable secure, passwordless login.</p>

  <button id="register-btn" class="btn btn-primary">Register Passkey</button>
  <div id="status" class="mt-3 text-success"></div>
  <div id="error" class="mt-2 text-danger"></div>
</div>

<script>
document.getElementById("register-btn").onclick = async () => {
    const status = document.getElementById("status");
    const error = document.getElementById("error");
    status.textContent = '';
    error.textContent = '';

    try {
        const res = await fetch("/auth/begin-webauthn-registration");
        const { public_key } = await res.json();

        const credential = await navigator.credentials.create({ publicKey: public_key });

        const response = {
            id: credential.id,
            rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
            type: credential.type,
            response: {
                attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject))),
                clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON)))
            },
            transports: credential.response.getTransports?.() || []
        };

        const verifyRes = await fetch("/auth/complete-webauthn-registration", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(response)
        });

        const verifyData = await verifyRes.json();
        if (verifyRes.status === 200) {
            status.textContent = "‚úÖ Registered successfully. Redirecting...";
            setTimeout(() => {
                window.location.href = "/login"; // or next desired URL
            }, 1500);
        } else {
            error.textContent = verifyData.error || "Registration failed.";
        }
    } catch (err) {
        console.error(err);
        error.textContent = "‚ö†Ô∏è Browser or device error.";
    }
};
</script>
{% endblock %}
